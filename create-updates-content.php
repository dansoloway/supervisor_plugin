<?php
/**
 * Create Updates Content Script
 * Seeds qa_updates with real content using existing taxonomies
 */

// Basic WordPress loading - same as working simple.php
if (!defined('ABSPATH')) {
    // Try to find wp-load.php
    $wp_load_paths = [
        '../../../wp-load.php',
        '../../wp-load.php',
        '../wp-load.php',
        'wp-load.php'
    ];
    
    $wp_loaded = false;
    foreach ($wp_load_paths as $path) {
        if (file_exists($path)) {
            require_once($path);
            $wp_loaded = true;
            break;
        }
    }
    
    if (!$wp_loaded) {
        die('Could not load WordPress. Please run this script from the plugin directory.');
    }
}

echo '<!DOCTYPE html>';
echo '<html dir="rtl" lang="he">';
echo '<head>';
echo '<meta charset="UTF-8">';
echo '<title>יצירת תוכן עדכונים</title>';
echo '<style>';
echo 'body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; background: #f9f9f9; border-radius: 8px; direction: rtl; }';
echo 'h1 { color: #333; text-align: center; }';
echo 'h3 { color: #0073aa; margin-top: 20px; }';
echo '.success { color: green; }';
echo '.error { color: red; }';
echo '.warning { color: orange; }';
echo '.summary { font-size: 18px; font-weight: bold; color: #0073aa; margin-top: 30px; }';
echo '</style>';
echo '</head>';
echo '<body>';

echo '<h1>יצירת תוכן עדכונים</h1>';

// Get all qa_themes terms
$themes = get_terms([
    'taxonomy' => 'qa_themes',
    'hide_empty' => false,
]);

// Get all qa_tags terms
$tags = get_terms([
    'taxonomy' => 'qa_tags',
    'hide_empty' => false,
]);

if (empty($themes) || empty($tags)) {
    echo '<p class="error">לא נמצאו קטגוריות qa_themes או qa_tags</p>';
    echo '</body></html>';
    exit;
}

echo '<p>נמצאו ' . count($themes) . ' תחומים ו-' . count($tags) . ' נושאי מפתח</p>';

// Define updates content for different themes and tags
$updates_content = [
    'בקרה עצמית' => [
        [
            'title' => 'הנחיות חדשות לבקרה עצמית בארגוני רווחה',
            'content' => 'פורסמו הנחיות מעודכנות לבקרה עצמית בארגוני רווחה. ההנחיות כוללות כלים דיגיטליים חדשים למדידת איכות שירותים ומנגנוני בקרה מרחוק. המסמך כולל דוגמאות מעשיות ומודלים ליישום.',
            'themes' => ['בקרה עצמית'],
            'tags' => ['בקרה עצמית', 'איכות']
        ],
        [
            'title' => 'מודל חדש לבקרה עצמית מבוסס תוצאות',
            'content' => 'אושר מודל חדש לבקרה עצמית המבוסס על מדידת תוצאות. המודל מאפשר לארגונים לעקוב אחר ביצועים ולשפר איכות שירותים באופן מתמיד. כולל כלים למדידה והערכה.',
            'themes' => ['בקרה עצמית'],
            'tags' => ['בקרה עצמית', 'תקנים']
        ]
    ],
    'אכיפה' => [
        [
            'title' => 'תקנות חדשות לאכיפת איכות בשירותי רווחה',
            'content' => 'אושרו תקנות חדשות לאכיפת איכות בשירותי רווחה. התקנות כוללות מנגנוני פיקוח ובקרה מתקדמים, וכן סנקציות על אי-עמידה בסטנדרטים. התקנות ייכנסו לתוקף בעוד 3 חודשים.',
            'themes' => ['אכיפה'],
            'tags' => ['אכיפה', 'תקנים']
        ],
        [
            'title' => 'מערכת דיגיטלית חדשה לאכיפת תקנים',
            'content' => 'הושקה מערכת דיגיטלית חדשה לאכיפת תקנים בארגוני רווחה. המערכת מאפשרת מעקב בזמן אמת אחר עמידה בתקנים ומספקת התראות על חריגות. המערכת זמינה לכל הארגונים הרשומים.',
            'themes' => ['אכיפה'],
            'tags' => ['אכיפה', 'חדשנות']
        ]
    ],
    'פיקוח' => [
        [
            'title' => 'דוח שנתי על מצב הפיקוח בארגוני רווחה',
            'content' => 'פורסם הדוח השנתי על מצב הפיקוח בארגוני רווחה. הדוח מציג שיפור משמעותי באיכות השירותים וכן זיהוי של תחומים הדורשים תשומת לב מיוחדת. כולל המלצות לשיפור נוסף.',
            'themes' => ['פיקוח'],
            'tags' => ['פיקוח', 'איכות']
        ],
        [
            'title' => 'הנחיות חדשות לפיקוח מרחוק',
            'content' => 'פורסמו הנחיות חדשות לפיקוח מרחוק בארגוני רווחה. ההנחיות כוללות שימוש בטכנולוגיות מתקדמות לפיקוח ובקרה מרחוק, תוך שמירה על פרטיות המטופלים.',
            'themes' => ['פיקוח'],
            'tags' => ['פיקוח', 'חדשנות']
        ]
    ],
    'תקנים' => [
        [
            'title' => 'עדכון תקן ISO 9001 לארגוני רווחה',
            'content' => 'פורסם עדכון לתקן ISO 9001 המותאם במיוחד לארגוני רווחה. התקן המעודכן כולל דרישות חדשות לאיכות שירותים ומדידת תוצאות. התקן החדש ייכנס לתוקף בעוד 6 חודשים.',
            'themes' => ['תקנים'],
            'tags' => ['תקנים', 'איכות']
        ],
        [
            'title' => 'תקן חדש לשקיפות בארגוני רווחה',
            'content' => 'אושר תקן חדש לשקיפות בארגוני רווחה. התקן מחייב פרסום מידע על איכות שירותים, תוצאות מדידות ופעולות לשיפור. התקן ייכנס לתוקף בעוד חודש.',
            'themes' => ['תקנים'],
            'tags' => ['תקנים', 'שקיפות']
        ]
    ],
    'מדיניות' => [
        [
            'title' => 'מדיניות חדשה לשיפור איכות שירותי רווחה',
            'content' => 'אושרה מדיניות חדשה לשיפור איכות שירותי רווחה. המדיניות כוללת תקציבים מיוחדים לשיפור תשתיות, הכשרת עובדים ופיתוח כלים דיגיטליים. המדיניות תתבצע במשך 3 שנים.',
            'themes' => ['מדיניות'],
            'tags' => ['מדיניות', 'איכות']
        ],
        [
            'title' => 'רפורמה במערכת הפיקוח על ארגוני רווחה',
            'content' => 'אושרה רפורמה מקיפה במערכת הפיקוח על ארגוני רווחה. הרפורמה כוללת הקמת גוף פיקוח עצמאי, הגדרת סטנדרטים חדשים ומנגנוני אכיפה משופרים. הרפורמה תתבצע בשלבים.',
            'themes' => ['מדיניות'],
            'tags' => ['מדיניות', 'פיקוח']
        ]
    ],
    'איכות' => [
        [
            'title' => 'מחקר חדש על איכות שירותי רווחה בישראל',
            'content' => 'פורסם מחקר מקיף על איכות שירותי רווחה בישראל. המחקר מציג שיפור משמעותי באיכות השירותים בשנים האחרונות, אך גם זיהוי של תחומים הדורשים שיפור. כולל המלצות מעשיות.',
            'themes' => ['איכות'],
            'tags' => ['איכות', 'מקצועיות']
        ],
        [
            'title' => 'כלים חדשים למדידת איכות שירותי רווחה',
            'content' => 'פותחו כלים חדשים למדידת איכות שירותי רווחה. הכלים כוללים שאלונים דיגיטליים, מדדי שביעות רצון ומערכות מעקב מתקדמות. הכלים זמינים לכל הארגונים.',
            'themes' => ['איכות'],
            'tags' => ['איכות', 'חדשנות']
        ]
    ],
    'מקצועיות' => [
        [
            'title' => 'תוכנית הכשרה חדשה לעובדי רווחה',
            'content' => 'אושרה תוכנית הכשרה חדשה לעובדי רווחה. התוכנית כוללת קורסים בנושאי איכות, פיקוח ובקרה, וכן כלים דיגיטליים לשיפור השירות. התוכנית תתחיל בעוד חודש.',
            'themes' => ['מקצועיות'],
            'tags' => ['מקצועיות', 'איכות']
        ],
        [
            'title' => 'סטנדרטים מקצועיים חדשים לעובדי רווחה',
            'content' => 'פורסמו סטנדרטים מקצועיים חדשים לעובדי רווחה. הסטנדרטים כוללים דרישות להכשרה מתמשכת, כללי אתיקה מקצועית ומנגנוני בקרה עצמית. הסטנדרטים מחייבים.',
            'themes' => ['מקצועיות'],
            'tags' => ['מקצועיות', 'תקנים']
        ]
    ],
    'שקיפות' => [
        [
            'title' => 'פלטפורמה חדשה לשקיפות בארגוני רווחה',
            'content' => 'הושקה פלטפורמה חדשה לשקיפות בארגוני רווחה. הפלטפורמה מאפשרת לציבור לגשת למידע על איכות שירותים, תוצאות מדידות ופעולות לשיפור. הפלטפורמה זמינה באינטרנט.',
            'themes' => ['שקיפות'],
            'tags' => ['שקיפות', 'חדשנות']
        ],
        [
            'title' => 'הנחיות חדשות לשקיפות בארגוני רווחה',
            'content' => 'פורסמו הנחיות חדשות לשקיפות בארגוני רווחה. ההנחיות מחייבות פרסום דוחות שנתיים על איכות שירותים, תוצאות מדידות ופעולות לשיפור. ההנחיות ייכנסו לתוקף בעוד חודש.',
            'themes' => ['שקיפות'],
            'tags' => ['שקיפות', 'תקנים']
        ]
    ],
    'אחריותיות' => [
        [
            'title' => 'מערכת חדשה למדידת אחריותיות בארגוני רווחה',
            'content' => 'הושקה מערכת חדשה למדידת אחריותיות בארגוני רווחה. המערכת מאפשרת מעקב אחר ביצועים, מדידת תוצאות והערכת אפקטיביות. המערכת כוללת כלים לדיווח וניתוח.',
            'themes' => ['אחריותיות'],
            'tags' => ['אחריותיות', 'חדשנות']
        ],
        [
            'title' => 'דוח על אחריותיות בארגוני רווחה',
            'content' => 'פורסם דוח מקיף על אחריותיות בארגוני רווחה. הדוח מציג שיפור משמעותי ברמת האחריותיות, אך גם זיהוי של תחומים הדורשים שיפור. כולל המלצות מעשיות.',
            'themes' => ['אחריותיות'],
            'tags' => ['אחריותיות', 'איכות']
        ]
    ],
    'מעורבות' => [
        [
            'title' => 'תוכנית חדשה למעורבות קהילתית בארגוני רווחה',
            'content' => 'אושרה תוכנית חדשה למעורבות קהילתית בארגוני רווחה. התוכנית כוללת מנגנונים לשיתוף פעולה עם הקהילה, שקיפות בקבלת החלטות ומעורבות משתמשי השירות. התוכנית תתחיל בעוד חודש.',
            'themes' => ['מעורבות'],
            'tags' => ['מעורבות', 'שקיפות']
        ],
        [
            'title' => 'כלים חדשים למעורבות משתמשי שירות',
            'content' => 'פותחו כלים חדשים למעורבות משתמשי שירות בארגוני רווחה. הכלים כוללים פלטפורמות דיגיטליות להעברת משוב, מנגנוני התייעצות ומערכות מעקב אחר שביעות רצון. הכלים זמינים לכל הארגונים.',
            'themes' => ['מעורבות'],
            'tags' => ['מעורבות', 'חדשנות']
        ]
    ],
    'חדשנות' => [
        [
            'title' => 'מענקים חדשים לחדשנות בארגוני רווחה',
            'content' => 'אושרו מענקים חדשים לחדשנות בארגוני רווחה. המענקים מיועדים לפיתוח כלים דיגיטליים, שיפור תהליכים ופיתוח מודלים חדשים לשיפור איכות שירותים. המענקים זמינים לכל הארגונים.',
            'themes' => ['חדשנות'],
            'tags' => ['חדשנות', 'איכות']
        ],
        [
            'title' => 'מרכז חדשנות חדש לארגוני רווחה',
            'content' => 'נפתח מרכז חדשנות חדש לארגוני רווחה. המרכז מספק ייעוץ, הכשרה וכלים לפיתוח פתרונות חדשניים לשיפור איכות שירותים. המרכז זמין לכל הארגונים.',
            'themes' => ['חדשנות'],
            'tags' => ['חדשנות', 'מקצועיות']
        ]
    ]
];

$created_count = 0;
$errors = [];

foreach ($updates_content as $category => $updates) {
    echo '<h3>קטגוריה: ' . esc_html($category) . '</h3>';
    
    foreach ($updates as $update) {
        // Create post
        $post_data = [
            'post_title' => $update['title'],
            'post_content' => $update['content'],
            'post_status' => 'publish',
            'post_type' => 'qa_updates',
            'post_author' => 1,
        ];
        
        $post_id = wp_insert_post($post_data);
        
        if (is_wp_error($post_id)) {
            $errors[] = 'שגיאה ביצירת עדכון: ' . $update['title'] . ' - ' . $post_id->get_error_message();
            echo '<p class="error">✗ שגיאה: ' . esc_html($update['title']) . '</p>';
            continue;
        }
        
        // Set theme terms
        if (!empty($update['themes'])) {
            $theme_terms = [];
            foreach ($update['themes'] as $theme_name) {
                $theme_term = get_term_by('name', $theme_name, 'qa_themes');
                if ($theme_term) {
                    $theme_terms[] = $theme_term->term_id;
                }
            }
            if (!empty($theme_terms)) {
                wp_set_object_terms($post_id, $theme_terms, 'qa_themes');
            }
        }
        
        // Set tag terms
        if (!empty($update['tags'])) {
            $tag_terms = [];
            foreach ($update['tags'] as $tag_name) {
                $tag_term = get_term_by('name', $tag_name, 'qa_tags');
                if ($tag_term) {
                    $tag_terms[] = $tag_term->term_id;
                }
            }
            if (!empty($tag_terms)) {
                wp_set_object_terms($post_id, $tag_terms, 'qa_tags');
            }
        }
        
        echo '<p class="success">✓ נוצר עדכון: ' . esc_html($update['title']) . '</p>';
        $created_count++;
    }
}

echo '<h2>סיכום</h2>';
echo '<p class="summary">נוצרו ' . $created_count . ' עדכונים</p>';

if (!empty($errors)) {
    echo '<h3>שגיאות:</h3>';
    foreach ($errors as $error) {
        echo '<p class="error">• ' . esc_html($error) . '</p>';
    }
}

echo '<p style="margin-top: 30px;"><a href="' . admin_url() . '" style="background: #0073aa; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px;">חזרה לניהול</a></p>';
echo '</body></html>';
?>
